# Протокол для взаимодействия с выносным инерциальным модулем

Данный документ описывает структуру пакетов данных для взаимодействия с выносным инерциальным модулем. Взаимодействие с контроллером выносного инерциального модуля и контроллером магнитного датчика происходит по принципу запрос/ответ.

---
## Общая структура протокола


|Byte Offset        |Number Format      |Name               |Description                                                        |
|:--------------    |:--------------    |:-----             |:---------                                                         |
|0                  |`uint16_t`       	|Start frame        |Символы старта пакета данных (для идентификации в потоке данных)   |
|2                  |`uint8_t`       	|Message ID         |Идентификатор сообщения                                            |
|3                  |`uint8_t`       	|Message status     |Битовое поле запросов                                              |
|3                  |`uint16_t`       	|Sensors status     |Битовое поле статусов измерителей                                  |
|от `4` до `x`      |`float/double`     |Payload            |Целевое сообщение                                                  |
|от`x+1` до `x+2`   |`uint16_t`         |crc                |Контрольная сумма (от 2-го байта до окончания байта Payload)       |

----
#### `Pack_requests` bitfield

|Name                               |Description    |
|---                                |---------- |
|7 бит `raw`/`calib`                |Если `0` - запрос сырых данных. Если `1` - запрос калиброванный данных     |
|6 бит `main_meas`/`reserve_meas`   |Если `0` - запрос данных от основных измерителей. Если `1` - запрос данных от резервных измерителей    |
|5 бит `read`/`write`               |Если `1` - контроллеру выносного инерциального датчика необходимо разобрать принятый пакет данных и записать его payload в свою оперативную память|
|4 бит `is_data_request`            |Если `0`, то пакет содержит `payload`. Если `1` - то запрос данных или команда (т.е. не содержит `payload`). |
|3 бит `unused`                     |Зарезервировано |
|2 бит `unused`                     |Зарезервировано |
|1 бит `unused`                     |Зарезервировано |
|0 бит `unused`                     |Зарезервировано |

---
#### `Sensors_status` bitfield

|Name                       |Description                                                        |
|---                        |----------                                                         |
|15 бит `acc_X_self_test`   |Бит, отвечающий за валидность `self test` акселерометра `X`        |
|14 бит `acc_Y_self_test`   |Бит, отвечающий за валидность `self test` акселерометра `Y`        |
|13 бит `acc_Z_self_test`   |Бит, отвечающий за валидность `self test` акселерометра `Z`        |
|12 бит `gyr_X_self_test`   |Бит, отвечающий за валидность `self test` гироскопа `X`            |
|11 бит `gyr_Y_self_test`   |Бит, отвечающий за валидность `self test` гироскопа `Y`            |
|10 бит `gyr_Z_self_test`   |Бит, отвечающий за валидность `self test` гироскопа `Z`            |
|9 бит `mag_X_self_test`    |Бит, отвечающий за валидность `self test` магнитометра `X`         |
|8 бит `mag_Y_self_test`    |Бит, отвечающий за валидность `self test` магнитометра `Y`         |
|7 бит `mag_Z_self_test`    |Бит, отвечающий за валидность `self test` магнитометра `Z`         |
|6 бит `unused`             |Зарезервировано                                                    |
|5 бит `unused`             |Зарезервировано                                                    |
|3 бит `unused`             |Зарезервировано                                                    |
|2 бит `unused`             |Зарезервировано                                                    |
|1 бит `unused`             |Зарезервировано                                                    |
|0 бит `unused`             |Зарезервировано                                                    |   

---
### Структура пакета сырых данных *основных* измерителей (`9dof_main_raw_pack_s`)
##### Данный пакет формирует контроллер выносного инерциального модуля и отправляет его по `UART` в ответ на запрос [сырых данных основных измерителей](#Запрос сырых данных основных измерителей)

> Магнитный датчик является отдельных устройством, которое соединяется с выносным инерциальным модулем через `UART`. Калибровка магнитометра также производится отдельно от остальных измерителей. Поэтому при калибровке акселерометров/гироскопов нет смысла учитывать данные `mag[3]` и `mag_self_test[3]`, они нужны для взаимодействия с контроллером автопилота. Для калибровки магнитометра [см. тут](#Структура пакета сырых данных магнитометра)

|Byte Offset|Number Format  |Name               |Value          |Description                                        |
|:--------- |:--------------|:-----             |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame        |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID         |`1u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests      |`0x00`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |Sensors status     |sens status    |Битовое поле статусов измерителей                  |
|6-11       |`int16_t`      |`acc[3]`           |meas by acc    |Измерения 3-х осей акселерометра (сырые данные)    |
|12-17      |`int16_t`      |`gyr[3]`           |meas by gyr    |Измерения 3-х осей гироскопа (сырые данные)        |
|18-23      |`int16_t`      |`mag[3]`           |meas by mag    |Измерения 3-х осей магнитометра (сырые данные)     |
|24-29      |`int16_t`      |`acc[3]_temp`      |acc temperature|Температура каждой оси акселерометра (сырые данные)|
|30-35      |`int16_t`      |`gyr[3]_temp`      |gyr temperature|Температура каждой оси гироскопа (сырые данные)    |
|36-41      |`int16_t`      |`mag_self_test[3]` |mag self test  |Self test каждой оси магнитометра (сырые данные)   |
|42-43      |`uint16_t`     |`CRC16_bits`      	|`Poly0x1021`   |Контрольная сумма (2-41 байты включительно)		|

---
### Структура пакета калиброванных данных *основных* измерителей (`9dof_main_calib_pack_s`)
##### Данный пакет формирует контроллер выносного инерциального модуля и отправляет его по `UART` в ответ на запрос [калиброванных данных основных измерителей](#Запрос калиброванных данных основных измерителей)
> Магнитный датчик является отдельных устройством, которое соединяется с выносным инерциальным модулем через `UART`. Калибровка магнитометра также производится отдельно от остальных измерителей. Поэтому при калибровке акселерометров/гироскопов нет смысла учитывать данные `mag[3]` и `mag_self_test[3]`, они нужны для взаимодействия с контроллером автопилота. Для калибровки магнитометра [см. тут](#Структура пакета сырых данных магнитометра)

|Byte Offset|Number Format  |Name               |Value          |Description                        						|
|:--------- |:------------- |:-----             |:---------     |:---------                         						|
|0          |`uint16_t`     |Start frame        |`0xAAAA`   	|Идентификатор начала пакета данных 						|
|2          |`uint8_t`      |Message ID         |`1u`           |Идентификатор сообщения            						|
|3          |`uint8_t`      |Pack requests      |`0x80`         |Битовое поле запросов             	 						|
|4-5        |`uint16_t`     |Sensors status     |sens status    |Битовое поле статусов измерителей  						|
|6-17       |`float`        |`acc[3]`           |meas by acc    |Измерения 3-х осей акселерометра (калиброванные данные) 	|
|18-29      |`float`        |`gyr[3]`           |meas by gyr    |Измерения 3-х осей гироскопа (калиброванные данные)     	|
|30-41      |`float`        |`mag[3]`           |meas by mag    |Измерения 3-х осей магнитометра (калиброванные данные)  	|
|42-53      |`float`        |`acc[3]_temp`      |acc temperature|Температура каждой оси акселерометра (нормированные данные)|
|54-65      |`float`        |`gyr[3]_temp`      |gyr temperature|Температура каждой оси гироскопа (нормированные данные)	|
|66-71      |`int16_t`      |`mag_self_test[3]` |mag self test  |Self test каждой оси магнитометра (сырые данные)   		|
|72-73      |`uint16_t`     |`CRC16_bits`      	|`Poly0x1021`   |Контрольная сумма  (2-71 байты включительно)               |

---
### Структура пакета сырых данных *резервных* измерителей (`9dof_reserve_raw_pack_s`)
##### Данный пакет формирует контроллер выносного инерциального модуля и отправляет его по `UART` в ответ на запрос [сырых данных резервных измерителей](#Запрос сырых данных резервных измерителей)
> Магнитный датчик является отдельных устройством, которое соединяется с выносным инерциальным модулем через `UART`. Калибровка магнитометра также производится отдельно от остальных измерителей. Поэтому при калибровке акселерометров/гироскопов нет смысла учитывать данные `mag[3]` и `mag_self_test[3]`, они нужны для взаимодействия с контроллером автопилота. Для калибровки магнитометра [см. тут](#Структура пакета сырых данных магнитометра)

|Byte Offset|Number Format  |Name               |Value          |Description                                        |
|:----------|:--------------|:-----             |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame        |`0xAAAA`   	|Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID         |`2u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests      |`0x00`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |Sensors status     |sens status    |Битовое поле статусов измерителей                  |
|6-11       |`int16_t`      |`acc[3]`           |meas by acc    |Измерения 3-х осей акселерометра (сырые данные)    |
|12-17      |`int16_t`      |`gyr[3]`           |meas by gyr    |Измерения 3-х осей гироскопа (сырые данные)        |
|18-23      |`int16_t`      |`mag[3]`           |meas by mag    |Измерения 3-х осей магнитометра (сырые данные)     |
|24-29      |`int16_t`      |`acc[3]_temp`      |acc temperature|Температура каждой оси акселерометра (сырые данные)|
|30-35      |`int16_t`      |`gyr[3]_temp`      |gyr temperature|Температура каждой оси гироскопа (сырые данные)    |
|36-41      |`int16_t`      |`mag_self_test[3]` |mag self test  |Self test каждой оси магнитометра (сырые данные)   |
|42-43      |`uint16_t`     |`CRC16_bits`      	|`Poly0x1021`   |Контрольная сумма (2-41 байты включительно)		|

---
### Структура пакета калиброванных данных *резервных* измерителей (`9dof_reserve_calib_pack_s`)
##### Данный пакет формирует контроллер выносного инерциального модуля и отправляет его по `UART` в ответ на запрос [калиброванных данных резервных измерителей](#Запрос калиброванных данных резервных измерителей)
> Магнитный датчик является отдельных устройством, которое соединяется с выносным инерциальным модулем через `UART`. Калибровка магнитометра также производится отдельно от остальных измерителей. Поэтому при калибровке акселерометров/гироскопов нет смысла учитывать данные `mag[3]` и `mag_self_test[3]`, они нужны для взаимодействия с контроллером автопилота. Для калибровки магнитометра [см. тут](#Структура пакета сырых данных магнитометра)

|Byte Offset|Number Format  |Name               |Value          |Description                                        		|
|:--------- |:--------------|:-----             |:---------     |:---------                                         		|
|0          |`uint16_t`     |Start frame        |`0xAAAA`       |Идентификатор начала пакета данных                 		|
|2          |`uint8_t`      |Message ID         |`2u`           |Идентификатор сообщения                            		|
|3          |`uint8_t`      |Pack requests      |`0x80`         |Битовое поле запросов                              		|
|4-5        |`uint16_t`     |Sensors status     |sens status    |Битовое поле статусов измерителей                  		|
|6-17       |`float`        |`acc[3]`           |meas by acc    |Измерения 3-х осей акселерометра (калиброванные данные) 	|
|18-29      |`float`        |`gyr[3]`           |meas by gyr    |Измерения 3-х осей гироскопа (калиброванные данные) 		|
|30-41      |`float`        |`mag[3]`           |meas by mag    |Измерения 3-х осей магнитометра (калиброванные данные) 	|
|42-53      |`float`        |`acc[3]_temp`      |acc temperature|Температура каждой оси акселерометра (нормированные данные)|
|54-65      |`float`        |`gyr[3]_temp`      |gyr temperature|Температура каждой оси гироскопа (нормированные данные)	|
|66-71      |`int16_t`      |`mag_self_test[3]` |mag self test  |Self test каждой оси магнитометра (сырые данные)   		|
|72-73      |`uint16_t`     |`CRC16_bits`      	|`Poly0x1021`   |Контрольная сумма (2-71 байты включительно)				|

---
### Структура пакета сырых данных магнитометра (`mag3dof_raw_pack_s`) <a name="Структура пакета сырых данных магнитометра"></a>
> Магнитометр представляет собой отдельное устройство с контроллером. Его калибровка производится отдельно от остальных измерителей, по этой причине для магнитометра нет деления на основной/резервный
#### Данный пакет формирует контроллер магнитометра и отправляет его по `UART` в ответ на команду [запроса сырых данных магнитометра](#Запрос сырых данных магнитометра)

|Byte Offset|Number Format  |Name               |Value          |Description                                        |
|:--------- |:--------------|:-----             |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame        |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID         |`6u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests      |`0x00`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |Sensors status     |sens status    |Битовое поле статусов измерителей                  |
|18-23      |`int16_t`      |`mag[3]`           |meas by mag    |Измерения 3-х осей магнитометра (сырые данные)     |
|24-29      |`int16_t`      |`mag_self_test[3]` |mag self test  |Self test 3-х осей магнитометра (сырые данные)     |
|30-31      |`uint16_t`     |`CRC16_bits`      	|`Poly0x1021`   |Контрольная сумма (2-29 байты включительно)		|

---
### Структура пакета калиброванных данных магнитометра (`mag3dof_calib_pack_s`) <a name="Структура пакета калиброванных данных магнитометра"></a>
> Магнитометр представляет собой отдельное устройство с контроллером. Его калибровка производится отдельно от остальных измерителей, по этой причине для магнитометра нет деления на основной/резервный
#### Данный пакет формирует контроллер магнитометра и отправляет его по `UART` в ответ на команду [запроса калиброванных данных магнитометра](#Запрос калиброванных данных магнитометра)

|Byte Offset|Number Format  |Name               |Value          |Description                                        |
|:--------- |:--------------|:-----             |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame        |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID         |`6u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests      |`0x80`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |Sensors status     |sens status    |Битовое поле статусов измерителей                  |
|18-29      |`float`      	|`mag[3]`           |meas by mag    |Измерения 3-х осей магнитометра (сырые данные)     |
|30-31      |`uint16_t`     |`CRC16_bits`      	|`Poly0x1021`   |Контрольная сумма (2-29 байты включительно)		|

---
### Структура пакета калибровочной матрицы акселерометров (основные измерители) (`acc3dof_main_calibmatrix_read_pack_s`)
##### Данный пакет данных формирует контроллер выносного инерциального датчика и отправляет его по `UART` в ответ на команду [запроса калибровочной матрицы акселерометров (основные измерители)](#Запрос калибровочной матрицы акселерометров (основные измерители))

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA    `   |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`3u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0x80`         |Битовое поле запросов                              |
|4-99       |`double`       |`matrix[3][4]` |               |Калибровочная матрица                              |
|100-101    |`uint16_t`     |`CRC16_bits`  	|`Poly0x1021`   |Контрольная сумма (2-99 байты включительно)		|

---
### Запись калибровочной матрицы акселерометров (основные измерители) (`acc3dof_main_calibmatrix_write_pack_s`)
##### При получении контроллером выносного инерциального датчика пакета данных, он записывает полученную калибровочную матрицу `matrix[3][4]` в свою оперативную память

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`3u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0xA0`         |Битовое поле запросов                              |
|4-99       |`double`       |`matrix[3][4]` |               |Калибровочная матрица                              |
|100-101    |`uint16_t`     |`CRC16_bits`   |`Poly0x1021`   |Контрольная сумма (2-99 байты включительно)		|

---
### Структура пакета калибровочной матрицы акселерометров (резервные измерители) (`acc3dof_reserve_calibmatrix_read_pack_s`)
##### Данный пакет данных формирует контроллер выносного инерциального датчика и отправляет его по `UART` в ответ на команду [запроса калибровочной матрицы акселерометров (резервные измерители)](#Запрос калибровочной матрицы акселерометров (резервные измерители))

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`3u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0xС0`         |Битовое поле запросов                              |
|4-99       |`double`       |`matrix[3][4]` |               |Калибровочная матрица                              |
|100-101    |`uint16_t`     |`CRC16_bits`   |`Poly0x1021`   |Контрольная сумма (2-99 байты включительно)		|

---
### Запись калибровочной матрицы акселерометров (резервные измерители) (`acc3dof_reserve_calibmatrix_write_pack_s`)
##### При получении контроллером выносного инерциального датчика пакета данных, он записывает полученную калибровочную матрицу `matrix[3][4]` в свою оперативную память

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:------------  |:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`   	|Message ID     |`3u`           |Идентификатор сообщения                            |
|3          |`uint8_t`   	|Pack requests  |`0xE0`         |Битовое поле запросов                              |
|4-99       |`double`       |`matrix[3][4]` |               |Калибровочная матрица                              |
|100-101    |`uint16_t`     |`CRC16_bits`   |`Poly0x1021`   |Контрольная сумма (2-99 байты включительно)		|

---
### Структура пакета калибровочной матрицы гироскопов (основные измерители) (`gyr3dof_main_calibmatrix_read_pack_s`)
##### Данный пакет данных формирует контроллер выносного инерциального датчика и отправляет его по `UART` в ответ на команду [запроса калибровочной матрицы гироскопов (основные измерители)](#Запрос калибровочной матрицы гироскопов (основные измерители))

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`4u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0x80`         |Битовое поле запросов                              |
|4-99       |`double`       |`matrix[3][4]` |               |Калибровочная матрица                              |
|100-101    |`uint16_t`     |`CRC16_bits`   |`Poly0x1021`   |Контрольная сумма (2-99 байты включительно)		|

---
### Запись калибровочной матрицы гироскопов (основные измерители) (`gyr3dof_main_calibmatrix_write_pack_s`)
##### При получении контроллером выносного инерциального датчика пакета данных, он записывает полученную калибровочную матрицу `matrix[3][4]` в свою оперативную память

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`4u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0xA0`         |Битовое поле запросов                              |
|4-99       |`double`       |`matrix[3][4]` |               |Калибровочная матрица                              |
|100-101    |`uint16_t`     |`CRC16_bits`  	|`Poly0x1021`   |Контрольная сумма (2-99 байты включительно)		|

---
### Структура пакета калибровочной матрицы гироскопов (резервные измерители) (`gyr3dof_reserve_calibmatrix_read_pack_s`)
##### Данный пакет данных формирует контроллер выносного инерциального датчика и отправляет его по `UART` в ответ на команду [запроса калибровочной матрицы гироскопов (резервные измерители)](#Запрос калибровочной матрицы гироскопов (резервные измерители))

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`4u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0xС0`         |Битовое поле запросов                              |
|4-99       |`double`       |`matrix[3][4]` |               |Калибровочная матрица                              |
|100-101    |`uint16_t`     |`CRC16_bits`  	|`Poly0x1021`   |Контрольная сумма (2-99 байты включительно)		|

---
### Запись калибровочной матрицы гироскопов (резервные измерители) (`gyr3dof_reserve_calibmatrix_write_pack_s`)
##### При получении контроллером выносного инерциального датчика пакета данных, он записывает полученную калибровочную матрицу `matrix[3][4]` в свою оперативную память

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`4u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0xE0`         |Битовое поле запросов                              |
|4-99       |`double`       |`matrix[3][4]` |               |Калибровочная матрица                              |
|100-101    |`uint16_t`     |`CRC16_bits`  	|`Poly0x1021`   |Контрольная сумма (2-99 байты включительно)		|

---
### Структура пакета калибровочной матрицы магнитометров (`mag3dof_calibmatrix_read_pack_s`)
##### Данный пакет данных формирует контроллер магнитометра и отправляет его по `UART` в ответ на команду [запроса калибровочной матрицы магнитометров](#Запрос калибровочной матрицы магнитометров)
> Магнитометр представляет собой отдельное устройство с контроллером. Его калибровка производится отдельно от остальных измерителей, по этой причине для магнитометра нет деления на основной/резервный.

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`5u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0x80`         |Битовое поле запросов                              |
|4-99       |`double`       |`matrix[3][4]` |               |Калибровочная матрица                              |
|100-101    |`uint16_t`     |`CRC16_bits`  	|`Poly0x1021`   |Контрольная сумма (2-99 байты включительно)		|

---
### Запись калибровочной матрицы магнитометров (`mag3dof_calibmatrix_write_pack_s`)
##### При получении контроллером магнитометра пакета данных, он записывает полученную калибровочную матрицу `matrix[3][4]` в свою оперативную память
> Магнитометр представляет собой отдельное устройство с контроллером. Его калибровка производится отдельно от остальных измерителей, по этой причине для магнитометра нет деления на основной/резервный.

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`5u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0xA0`         |Битовое поле запросов                              |
|4-99       |`double`       |`matrix[3][4]` |               |Калибровочная матрица                              |
|100-101    |`uint16_t`     |`CRC16_bits`  	|`Poly0x1021`   |Контрольная сумма (2-99 байты включительно)		|


### Запросы данных ###

В данном разделе описаны команды для передачи в контроллер выносного инерциального датчика и в контроллер магнитометра

---
#### Запрос сырых данных основных измерителей (`9dof_main_raw_request_cmd_s`) <a name="Запрос сырых данных основных измерителей"></a>

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`1u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0x10`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |`CRC16_bits`  	|`Poly0x1021`   |Контрольная сумма                 					|

---
#### Запрос калиброванных данных основных измерителей (`9dof_main_calib_request_cmd_s`) <a name="Запрос калиброванных данных основных измерителей"></a>

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:--------- |:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`1u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0x90`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |`CRC16_bits`  	|`Poly0x1021`   |Контрольная сумма с 2 по 3 байты включительно      |

---
#### Запрос сырых данных резервных измерителей (`9dof_reserve_raw_request_cmd_s`) <a name="Запрос сырых данных резервных измерителей"></a>

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:----------|:------------- |:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`2u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0x10`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |`CRC16_bits`   |`Poly0x1021`   |Контрольная сумма с 2 по 3 байты включительно      |

---
#### Запрос калиброванных данных резервных измерителей (`9dof_reserve_calib_request_cmd_s`) <a name="Запрос калиброванных данных резервных измерителей"></a>

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:----------|:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`2u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0x90`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |`CRC16_bits`	|`Poly0x1021`   |Контрольная сумма с 2 по 3 байты включительно      |

---
#### Запрос калибровочной матрицы акселерометров (основные измерители) (`acc3dof_main_calib_matrix_request_cmd_s`) <a name="Запрос калибровочной матрицы акселерометров (основные измерители)"></a>

|Byte Offset    |Number Format  |Name           |Value          |Description                                        |
|:--------------|:--------------|:-----         |:---------     |:---------                                         |
|0              |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2              |`uint8_t`      |Message ID     |`3u`           |Идентификатор сообщения                            |
|3              |`uint8_t`      |Pack requests  |`0x90`         |Битовое поле запросов                              |
|4-5            |`uint16_t`     |`CRC16_bits`	|`Poly0x1021`   |Контрольная сумма с 2 по 3 байты включительно      |

---
#### Запрос калибровочной матрицы акселерометров (резервные измерители) (`acc3dof_reserve_calib_matrix_request_cmd_s`) <a name="Запрос калибровочной матрицы акселерометров (резервные измерители)"></a>

|Byte Offset    |Number Format  |Name           |Value          |Description                                        |
|:--------------|:--------------|:-----         |:---------     |:---------                                         |
|0              |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2              |`uint8_t`      |Message ID     |`3u`           |Идентификатор сообщения                            |
|3              |`uint8_t`      |Pack requests  |`0xD0`         |Битовое поле запросов                              |
|4-5            |`uint16_t`     |`CRC16_bits`	|`Poly0x1021`   |Контрольная сумма с 2 по 3 байты включительно      |

---
#### Запрос калибровочной матрицы гироскопов (основные измерители) (`gyr3dof_main_calib_matrix_request_cmd_s`) <a name="Запрос калибровочной матрицы гироскопов (основные измерители)"></a>

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:----------|:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`4u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0x90`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |`CRC16_bits`	|`Poly0x1021`   |Контрольная сумма с 2 по 3 байты включительно      |

---
#### Запрос калибровочной матрицы гироскопов (резервные измерители) (`gyr3dof_reserve_calib_matrix_request_cmd_s`) <a name="Запрос калибровочной матрицы гироскопов (резервные измерители)"></a>

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:----------|:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`4u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0xD0`         |Битовое поле                                       |
|4-5        |`uint16_t`     |`CRC16_bits`	|`Poly0x1021`   |Контрольная сумма с 2 по 3 байты включительно      |

---
#### Запрос калибровочной матрицы магнитометров (`mag3dof_calib_matrix_request_cmd_s`) <a name="Запрос калибровочной матрицы магнитометров"></a>
> Магнитометр представляет собой отдельное устройство с контроллером. Его калибровка производится отдельно от остальных измерителей, по этой причине для магнитометра нет деления на основной/резервный.

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:----------|:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`   	|Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`   	|Message ID     |`5u`           |Идентификатор сообщения                            |
|3          |`uint8_t`   	|Pack requests  |`0x90`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |`CRC16_bits`	|`Poly0x1021`   |Контрольная сумма с 2 по 3 байты включительно      |

---
#### Запрос сырых данных магнитометра (`mag3dof_raw_request_cmd_s`) <a name="Запрос сырых данных магнитометра"></a>
> Магнитометр представляет собой отдельное устройство с контроллером. Его калибровка производится отдельно от остальных измерителей, по этой причине для магнитометра нет деления на основной/резервный

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:----------|:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`6u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0x10`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |`CRC16_bits` 	|`Poly0x1021`   |Контрольная сумма с 2 по 3 байты включительно      |

---
#### Запрос калиброванных данных магнитометра (`mag3dof_calib_request_cmd_s`) <a name="Запрос калиброванных данных магнитометра"></a>
> Магнитометр представляет собой отдельное устройство с контроллером. Его калибровка производится отдельно от остальных измерителей, по этой причине для магнитометра нет деления на основной/резервный

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:----------|:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`6u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0x90`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |`CRC16_bits`	|`Poly0x1021`   |Контрольная сумма с 2 по 3 байты включительно      |


---
#### Команда на запись калибровочных матриц в `eeprom` (`write_all_calib_matrix_in_eeprom_cmd_s`)

Данная команда инициирует запись следующих калибровочных матриц из ОЗУ контроллера выносного инерциального модуля в его ПЗУ:

- калибровочная матрица акселерометров (основные измерители);
- калибровочная матрица акселерометров (резервные измерители);
- калибровочная матрица гироскопов (основные измерители);
- калибровочная матрица гироскопов (резервные измерители).

Также, если команда отправляется контроллеру магнитного датчика, то инициируется запись следующих калибровочных матриц:

- калибровочная матрица магнитометров.

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:----------|:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|2          |`uint8_t`      |Message ID     |`7u`           |Идентификатор сообщения                            |
|3          |`uint8_t`      |Pack requests  |`0xB0`         |Битовое поле запросов                              |
|4-5        |`uint16_t`     |`CRC16_bits`	|`Poly0x1021`   |Контрольная сумма с 2 по 3 байты включительно      |

При подаче питания на контроллер выносного инерциального модуля или магнитометра, производится копирование всех калибровочных матриц из ПЗУ в ОЗУ с проверкой валидности считанных данных.

---
#### Структура сообщения ответа контроллера выносного инерциального датчика и контроллера магнитного датчика (`response_cmd_s`)

Коды статусов ответных сообщений, посылаемых контроллерами `Response_code`:

- ERROR = 200u,
- INVALID_CRC = 201u,
- INVALID_ID = 202u,
- INVALID_CALIBRATION_MATRIX_FROM_EEPROM = 203u,
- OK = 204u,

|Byte Offset|Number Format  |Name           |Value          |Description                                        |
|:----------|:--------------|:-----         |:---------     |:---------                                         |
|0          |`uint16_t`     |Start frame    |`0xAAAA`       |Идентификатор начала пакета данных                 |
|1          |`uint8_t`      |Message ID     |`Response_code`|Код ответного сообщения                            |
|2        	|`uint8_t`     	|End frame      |`0x55`    		|Идентификатор окончания пакета данных      		|

> Сообщение отправляется контроллером в ответ на следующие пакеты данных:
> 
> - `acc_main_calib_matrix_write_pack_s`
> - `acc_reserv_calib_matrix_write_pack_s`
> - `gyr_main_calib_matrix_write_pack_s`
> - `gyr_reserv_calib_matrix_write_pack_s`
> - `mag_calib_matrix_write_pack_s`

